openapi: 3.0.3
info:
  title: Turing Labs Backend API
  description: |
    Backend API for Turing Labs sensory testing platform.
    
    This API provides endpoints for managing taste testing trials, participants, recipes, 
    and submissions. It supports voice memo uploads and transcription for detailed sensory feedback.
    
    ## Authentication
    Most endpoints require JWT authentication via Auth0. Include the access token in the 
    Authorization header: `Bearer <token>`
    
    ## Base URL
    The API is hosted on AWS API Gateway. Use the stage-specific URL provided by your deployment.
    
  version: 1.0.0
  contact:
    name: Turing Labs
    email: support@turinglabs.com

servers:
  - url: https://z0u3xpkz59.execute-api.us-west-2.amazonaws.com/dev
    description: Development server

tags:
  - name: Users
    description: User management operations
  - name: Participants
    description: Manage trial participants
  - name: Recipes
    description: Manage recipes for taste testing
  - name: Trials
    description: Manage testing trials
  - name: Submissions
    description: Manage sensory test submissions
  - name: Voice Memos
    description: Voice memo upload and management
  - name: Transcription
    description: Voice memo transcription

paths:
  $ref: './paths/index.yaml'

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token from Auth0. Include as "Bearer <token>" in Authorization header.
    
    Auth0Webhook:
      type: apiKey
      in: header
      name: Authorization
      description: Auth0 webhook secret for user creation endpoint

  parameters:
    ParticipantId:
      name: id
      in: path
      required: true
      description: Unique identifier for the participant
      schema:
        type: string
        format: uuid

    RecipeId:
      name: id
      in: path
      required: true
      description: Unique identifier for the recipe
      schema:
        type: string
        format: uuid

    TrialId:
      name: id
      in: path
      required: true
      description: Unique identifier for the trial
      schema:
        type: string
        format: uuid

    SubmissionId:
      name: id
      in: path
      required: true
      description: Unique identifier for the submission
      schema:
        type: string

  schemas:
    # User schemas
    User:
      type: object
      properties:
        user_id:
          type: string
          format: uuid
          description: Unique identifier for the user
        email:
          type: string
          format: email
          description: User's email address
        name:
          type: string
          description: User's full name
        created_at:
          type: string
          format: date-time
          description: Timestamp when user was created

    CreateUserRequest:
      type: object
      required:
        - email
        - name
      properties:
        email:
          type: string
          format: email
          description: User's email address
        name:
          type: string
          description: User's full name

    # Participant schemas
    Participant:
      type: object
      properties:
        participant_id:
          type: string
          format: uuid
          description: Unique identifier for the participant
        trial_id:
          type: string
          format: uuid
          description: ID of the trial this participant belongs to
        code:
          type: string
          pattern: '^\d{6}$'
          description: Unique 6-digit code for participant identification
          example: "123456"
        name:
          type: string
          description: Participant's name
        tasks_completed:
          type: integer
          description: Number of tasks completed by the participant
          default: 0

    CreateParticipantRequest:
      type: object
      required:
        - trial_id
        - name
      properties:
        trial_id:
          type: string
          format: uuid
          description: ID of the trial to add the participant to
        name:
          type: string
          description: Participant's name

    UpdateParticipantRequest:
      type: object
      properties:
        name:
          type: string
          description: Updated participant name
        tasks_completed:
          type: integer
          description: Updated number of tasks completed

    # Recipe schemas
    Recipe:
      type: object
      properties:
        recipe_id:
          type: string
          format: uuid
          description: Unique identifier for the recipe
        trial_id:
          type: string
          format: uuid
          description: ID of the trial this recipe belongs to
        recipe_name:
          type: string
          description: Name of the recipe
        sugar:
          type: number
          format: float
          description: Amount of sugar in grams
        stevia_extract:
          type: number
          format: float
          description: Amount of stevia extract in grams
        allulose:
          type: number
          format: float
          description: Amount of allulose in grams
        citric_acid:
          type: number
          format: float
          description: Amount of citric acid in grams
        target_sugar_reduction_percent:
          type: number
          format: float
          description: Target percentage of sugar reduction
        target_cost_per_unit:
          type: number
          format: float
          description: Target cost per unit in dollars
        prediction:
          type: string
          description: AI-generated prediction or notes about the recipe

    CreateRecipeRequest:
      type: object
      required:
        - trial_id
        - recipe_name
        - sugar
        - stevia_extract
        - allulose
        - citric_acid
        - target_sugar_reduction_percent
        - target_cost_per_unit
      properties:
        trial_id:
          type: string
          format: uuid
          description: ID of the trial this recipe belongs to
        recipe_name:
          type: string
          description: Name of the recipe
        sugar:
          type: number
          format: float
          description: Amount of sugar in grams
        stevia_extract:
          type: number
          format: float
          description: Amount of stevia extract in grams
        allulose:
          type: number
          format: float
          description: Amount of allulose in grams
        citric_acid:
          type: number
          format: float
          description: Amount of citric acid in grams
        target_sugar_reduction_percent:
          type: number
          format: float
          description: Target percentage of sugar reduction
        target_cost_per_unit:
          type: number
          format: float
          description: Target cost per unit in dollars
        prediction:
          type: string
          description: AI-generated prediction or notes about the recipe

    UpdateRecipeRequest:
      type: object
      required:
        - trial_id
      properties:
        trial_id:
          type: string
          format: uuid
          description: ID of the trial (required for composite key)
        recipe_name:
          type: string
          description: Updated recipe name
        sugar:
          type: number
          format: float
          description: Updated amount of sugar
        stevia_extract:
          type: number
          format: float
          description: Updated amount of stevia extract
        allulose:
          type: number
          format: float
          description: Updated amount of allulose
        citric_acid:
          type: number
          format: float
          description: Updated amount of citric acid
        target_sugar_reduction_percent:
          type: number
          format: float
          description: Updated target sugar reduction percentage
        target_cost_per_unit:
          type: number
          format: float
          description: Updated target cost per unit
        prediction:
          type: string
          description: Updated prediction

    # Trial schemas
    Trial:
      type: object
      properties:
        trial_id:
          type: string
          format: uuid
          description: Unique identifier for the trial
        trial_name:
          type: string
          description: Name of the trial
        status:
          type: string
          enum: [draft, active, completed, archived]
          description: Current status of the trial
        trial_date:
          type: string
          format: date
          description: Date when the trial is scheduled or was conducted

    CreateTrialRequest:
      type: object
      required:
        - trial_name
        - status
        - trial_date
      properties:
        trial_name:
          type: string
          description: Name of the trial
        status:
          type: string
          enum: [draft, active, completed, archived]
          description: Initial status of the trial
        trial_date:
          type: string
          format: date
          description: Date for the trial

    UpdateTrialRequest:
      type: object
      properties:
        trial_name:
          type: string
          description: Updated trial name
        status:
          type: string
          enum: [draft, active, completed, archived]
          description: Updated status
        trial_date:
          type: string
          format: date
          description: Updated trial date

    # Submission schemas
    Submission:
      type: object
      properties:
        submission_id:
          type: string
          description: Unique identifier for the submission (format participant_id::recipe_id::outcome)
        recipe_id:
          type: string
          format: uuid
          description: ID of the recipe being evaluated
        trial_id:
          type: string
          format: uuid
          description: ID of the trial this submission belongs to
        participant_id:
          type: string
          format: uuid
          description: ID of the participant who made the submission
        score:
          type: number
          format: float
          minimum: 0
          maximum: 10
          description: Sensory evaluation score (0-10)
        status:
          type: string
          enum: [draft, saved]
          description: Status of the submission
        notes:
          type: string
          description: Text notes from the participant
        voice_memo_key:
          type: string
          description: S3 key of the associated voice memo
        last_updated:
          type: string
          format: date-time
          description: Timestamp of last update

    CreateSubmissionRequest:
      type: object
      required:
        - recipe_id
        - trial_id
        - participant_id
        - score
      properties:
        submission_id:
          type: string
          description: Optional custom submission ID (format participant_id::recipe_id::outcome)
        recipe_id:
          type: string
          format: uuid
          description: ID of the recipe being evaluated
        trial_id:
          type: string
          format: uuid
          description: ID of the trial
        participant_id:
          type: string
          format: uuid
          description: ID of the participant
        score:
          type: number
          format: float
          minimum: 0
          maximum: 10
          description: Sensory evaluation score (0-10)
        status:
          type: string
          enum: [draft, saved]
          default: draft
          description: Status of the submission
        notes:
          type: string
          description: Text notes from the participant
        voice_memo_key:
          type: string
          description: S3 key of the associated voice memo

    UpdateSubmissionRequest:
      type: object
      properties:
        score:
          type: number
          format: float
          minimum: 0
          maximum: 10
          description: Updated score
        status:
          type: string
          enum: [draft, saved]
          description: Updated status
        notes:
          type: string
          description: Updated notes
        voice_memo_key:
          type: string
          description: Updated voice memo S3 key

    # Error schemas
    Error:
      type: object
      properties:
        error:
          type: string
          description: Error type or category
        message:
          type: string
          description: Detailed error message

  responses:
    BadRequest:
      description: Bad request - Invalid input data
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Bad Request"
            message: "Required fields are missing"

    Unauthorized:
      description: Unauthorized - Authentication required or failed
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Unauthorized"
            message: "Invalid or missing authentication token"

    NotFound:
      description: Not found - Resource does not exist
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Not Found"
            message: "The requested resource was not found"

    InternalError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error: "Internal Server Error"
            message: "An unexpected error occurred"
